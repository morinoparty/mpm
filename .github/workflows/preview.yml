name: preview.yml
on:
  pull_request:
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

env:
  PREVIEW_BASE_URL: https://moripa-ci.nikomaru.dev/mpm
  PROJECT_NAME: mpm

jobs:
  # Gradle „Éì„É´„Éâ (JAR + „ÉÜ„Çπ„Éà + detekt)
  build-jar:
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.vars.outputs.sha }}
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Set short git commit SHA
        id: vars
        run: |
          calculatedSha=$(git rev-parse --short HEAD)
          echo "sha=$calculatedSha" >> $GITHUB_OUTPUT

      - name: Change plugin.yml version
        run: |
          before="$GITHUB_ENV"
          after="${before//v/}"
          sed -i 's/VersionPlaceholder/$after/' ./gradle.properties

      - name: Build with Gradle
        continue-on-error: true
        run: ./gradlew build --parallel

      - name: Publish test results
        id: publish-test-results
        uses: mikepenz/action-junit-report@a294a61c909bd8a4b563024a2faa28897fd53ebc # v6.1.0
        if: success() || failure()
        with:
          report_paths: './**/build/test-results/test/TEST-*.xml'

      - name: Upload JAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifacts
          retention-days: 1
          path: |
            paper/build/libs/paper-*-all.jar
            api/build/libs/api-*.jar
            paper/build/reports/tests/test/
            build/reports/detekt/

  # Dokka „Éâ„Ç≠„É•„É°„É≥„ÉàÁîüÊàê
  build-dokka:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Generate Dokka API documentation
        run: ./gradlew dokkaGenerate

      - name: Upload Dokka artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dokka-artifacts
          retention-days: 1
          path: docs/docs/dokka/

  # Docs „Éì„É´„Éâ
  build-docs:
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.vars.outputs.sha }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'

      - uses: pnpm/action-setup@b9e1dbc72ff7358f971cc0b7c62c7a0d83f1068b # v4.0.0
        name: Install pnpm
        with:
          version: 10
          run_install: false

      - name: Set short git commit SHA
        id: vars
        run: |
          calculatedSha=$(git rev-parse --short HEAD)
          echo "sha=$calculatedSha" >> $GITHUB_OUTPUT

      - name: Install docs dependencies
        working-directory: docs
        run: pnpm i --frozen-lockfile

      - name: Build docs
        working-directory: docs
        env:
          BASE_PATH: /mpm/${{ steps.vars.outputs.sha }}/docs
          NEXT_PUBLIC_BASE_PATH: /mpm/${{ steps.vars.outputs.sha }}/docs
        run: pnpm run build

      - name: Upload docs artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docs-artifacts
          retention-days: 1
          path: docs/out/

  # S3 „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ & PR„Ç≥„É°„É≥„Éà
  upload:
    needs: [build-jar, build-dokka, build-docs]
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_EC2_METADATA_DISABLED: true
      AWS_REGION: auto
      AWS_CLI_FILE_ENCODING: UTF-8
      AWS_DEFAULT_S3_SIGNATURE_VERSION: s3v4
      S3_UPLOAD_BUCKET: ${{ secrets.S3_UPLOAD_BUCKET }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      COMMIT_SHORT_SHA: ${{ needs.build-jar.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare upload directory
        run: |
          mkdir -p ./upload/jars
          mkdir -p ./upload/junit
          mkdir -p ./upload/detekt
          mkdir -p ./upload/docs
          mkdir -p ./upload/dokka

          # JAR artifacts
          mv artifacts/jar-artifacts/paper/build/libs/paper-*-all.jar ./upload/jars/${{ env.PROJECT_NAME }}-paper-${{ env.COMMIT_SHORT_SHA }}.jar || true
          mv artifacts/jar-artifacts/api/build/libs/api-*.jar ./upload/jars/${{ env.PROJECT_NAME }}-api-${{ env.COMMIT_SHORT_SHA }}.jar || true
          cp -r artifacts/jar-artifacts/paper/build/reports/tests/test/* ./upload/junit/ || true
          cp -r artifacts/jar-artifacts/build/reports/detekt/* ./upload/detekt/ || true

          # Dokka artifacts
          cp -r artifacts/dokka-artifacts/* ./upload/dokka/ || true

          # Docs artifacts
          cp -r artifacts/docs-artifacts/* ./upload/docs/

      - name: Upload to S3
        run: |
          # AWS CLI„ÅÆ‰∏¶Âàó„É™„ÇØ„Ç®„Çπ„ÉàÊï∞„ÇíÂ¢ó„ÇÑ„Åô
          aws configure set default.s3.max_concurrent_requests 50

          S3_BASE="s3://${{ env.S3_UPLOAD_BUCKET }}/mpm/${{ env.COMMIT_SHORT_SHA }}"
          S3_OPTS="--endpoint-url ${S3_ENDPOINT} --only-show-errors"

          # ÂêÑ„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰∏¶Âàó„Åß„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
          aws s3 cp ./upload/jars $S3_BASE/jars $S3_OPTS --recursive &
          aws s3 cp ./upload/junit $S3_BASE/junit $S3_OPTS --recursive &
          aws s3 cp ./upload/detekt $S3_BASE/detekt $S3_OPTS --recursive &
          aws s3 cp ./upload/dokka $S3_BASE/dokka $S3_OPTS --recursive &
          aws s3 cp ./upload/docs $S3_BASE/docs $S3_OPTS --recursive &

          # ÂÖ®„Å¶„ÅÆ‰∏¶Âàó„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„ÇíÂæÖÊ©ü
          wait
          echo "S3 upload completed"

      - name: Get limit time
        id: limit-time
        run: |
          limit_time=$(date -d "7 days" +%Y-%m-%d)
          echo "LIMIT_TIME=$limit_time" >> $GITHUB_ENV

      - name: Create comment file
        env:
          ARTIFACT_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/jars/${{ env.PROJECT_NAME }}-paper-${{ env.COMMIT_SHORT_SHA }}.jar"
          ARTIFACT_URL_API: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/jars/${{ env.PROJECT_NAME }}-api-${{ env.COMMIT_SHORT_SHA }}.jar"
          JUNIT_REPORT_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/junit/index.html"
          DETEKT_REPORT_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/detekt/detekt.html"
          DOCS_PREVIEW_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/docs/intro/index.html"
          DOKKA_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/dokka/index.html"
          LIMIT_TIME: ${{ env.LIMIT_TIME }}
        run: |
          cat  << EOF > comment.md
          ## üöÄ Preview of ${{ github.event.repository.name }}
          This preview file are availalble for 7 days. (until $LIMIT_TIME)
          <table>
            <tr>
              <th scope="row">üìñ Documentation Preview</th>
              <td><a href="$DOCS_PREVIEW_URL">$DOCS_PREVIEW_URL</a></td>
            </tr>
            <tr>
              <th scope="row">üì¶ Preview Jars Bukkit</th>
              <td><a href="$ARTIFACT_URL">$ARTIFACT_URL</a></td>
            </tr>
            <tr>
              <th scope="row">üîå Preview Jars API</th>
              <td><a href="$ARTIFACT_URL_API">$ARTIFACT_URL_API</a></td>
            </tr>
            <tr>
              <th scope="row">üìñ Dokka API Documentation</th>
              <td><a href="$DOKKA_URL">$DOKKA_URL</a></td>
            </tr>
            <tr>
              <th scope="row">üß™ JUnit Report</th>
              <td><a href="$JUNIT_REPORT_URL">$JUNIT_REPORT_URL</a></td>
            </tr>
            <tr>
              <th scope="row">üîç Detekt Report</th>
              <td><a href="$DETEKT_REPORT_URL">$DETEKT_REPORT_URL</a></td>
            </tr>
          </table>
          EOF

      - name: Create PR comment
        if: ${{ github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize') }}
        run: gh pr comment ${{ github.event.number }} --body-file comment.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
